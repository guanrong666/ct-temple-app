<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金山承天宮發財金管理</title>
    <!-- 載入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Google Fonts - Noto Sans TC (用於中文顯示) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- 載入 Firebase JS SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // 匯入 deleteDoc 供刪除會員資料使用
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, setLogLevel, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firebase Debug Log
        setLogLevel('debug');
        
        // --- 全域變數定義 (來自 Canvas 環境) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let membersData = []; // 儲存所有會員資料
        let isAuthReady = false;
        let currentEditingMemberId = null; // 儲存正在編輯的 firestoreId
        let currentDeletingMemberId = null; // 儲存正在刪除的 firestoreId

        // 客製化 Tailwind 配置 (用於黑金奢華風格)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'luxury-black': '#1a1a1a',
                        'luxury-gold': '#FFD700',
                        'luxury-gold-dark': '#B8860B',
                        'luxury-bg': '#000000',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                },
            }
        }
        
        // --- 初始化 Firebase 與身份驗證 ---
        const initFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserLocalPersistence);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase 認證成功，使用者 ID:", userId);
                    } else {
                        // 嘗試使用自定義 Token 登入，失敗則匿名登入
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    isAuthReady = true;
                    // 認證完成，隱藏載入畫面並顯示應用程式
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    
                    if (userId) {
                        document.getElementById('user-id-display').textContent = `使用者ID: ${userId}`;
                        setupRealtimeListener();
                    }
                    
                    // 初始進入點：直接顯示儀表板
                    showView('dashboard');
                });
            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                document.getElementById('error-message').textContent = `錯誤: ${error.message}`;
                document.getElementById('loading-overlay').classList.remove('hidden');
            }
        };

        // --- Firestore 實時監聽 ---
        const COLLECTION_PATH = `artifacts/${appId}/public/data/prosperity_money`;

        const setupRealtimeListener = () => {
            const memberRef = collection(db, COLLECTION_PATH);
            const q = query(memberRef);

            onSnapshot(q, (snapshot) => {
                const updatedMembers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // 確保 memberId 存在並排序
                    updatedMembers.push({ ...data, firestoreId: doc.id }); 
                });
                
                // 依編號 (memberId) 排序
                membersData = updatedMembers.sort((a, b) => (a.memberId || 0) - (b.memberId || 0));
                console.log("會員資料已更新:", membersData);
                
                // 重新渲染查詢和還款頁面
                if (currentView === 'query') renderQueryResults(null);
                if (currentView === 'repay') renderRepayResults(null);
                
                // 更新新增頁面的自動編號
                if (currentView === 'new') resetNewMemberForm();


            }, (error) => {
                console.error("監聽資料庫失敗: ", error);
            });
        };

        // --- 核心應用程式邏輯 ---
        
        let currentView = 'dashboard'; 

        const showView = (viewName) => {
            currentView = viewName;
            const views = document.querySelectorAll('.app-view');
            views.forEach(v => v.classList.add('hidden'));
            
            const targetView = document.getElementById(`${viewName}-view`);
            if (targetView) {
                targetView.classList.remove('hidden');
            }
            
            // 特殊處理：進入查詢和還款頁面時，清除前一次結果
            if (viewName === 'query' || viewName === 'repay') {
                document.getElementById('search-input-query').value = '';
                document.getElementById('search-input-repay').value = '';
                document.getElementById('query-results').innerHTML = '';
                document.getElementById('repay-results').innerHTML = '';
            }

            if (viewName === 'new') {
                resetNewMemberForm();
            }
        };

        // --- 查詢邏輯 (Query / Repay 共用) ---

        const searchMembers = (searchTerm) => {
            if (!searchTerm) return [];
            const term = searchTerm.toLowerCase().trim();
            return membersData.filter(member => {
                const memberIdMatch = String(member.memberId) === term;
                const nameMatch = member.name && member.name.toLowerCase().includes(term);
                const idCardMatch = member.idCard === term;
                const phoneMatch = member.phone === term;
                return memberIdMatch || nameMatch || idCardMatch || phoneMatch;
            });
        };

        // --- 查詢頁面 (Query View) ---
        
        const handleQuerySearch = () => {
            const searchTerm = document.getElementById('search-input-query').value.trim();
            const results = searchMembers(searchTerm);
            renderQueryResults(results);
        };
        
        const renderQueryResults = (results) => {
            const resultsEl = document.getElementById('query-results');
            resultsEl.innerHTML = '';
            
            if (results === null) {
                return;
            }

            if (results.length === 0) {
                resultsEl.innerHTML = `<p class="text-luxury-gold text-center py-4">查無符合條件的會員資料。</p>`;
                return;
            }

            results.forEach(member => {
                resultsEl.innerHTML += createMemberCard(member, false); // false for read-only
            });
        };

        // --- 還錢/更新頁面 (Repay View) ---
        
        const handleRepaySearch = () => {
            const searchTerm = document.getElementById('search-input-repay').value.trim();
            const results = searchMembers(searchTerm);
            renderRepayResults(results);
        };
        
        const renderRepayResults = (results) => {
            const resultsEl = document.getElementById('repay-results');
            resultsEl.innerHTML = '';
            
            if (results === null) {
                return;
            }

            if (results.length === 0) {
                resultsEl.innerHTML = `<p class="text-luxury-gold text-center py-4">查無符合條件的會員資料，無法進行還款更新。</p>`;
                return;
            }

            results.forEach(member => {
                resultsEl.innerHTML += createMemberCard(member, true); // true for editable
            });
        };
        
        // 處理打開編輯視窗
        const openEditModal = (firestoreId) => {
            const member = membersData.find(m => m.firestoreId === firestoreId);
            if (!member) {
                return displayMessage('找不到該會員資料。', 'error');
            }
            
            currentEditingMemberId = firestoreId;
            
            // Populate modal fields
            document.getElementById('edit-modal-title').textContent = `編輯 ${member.name} (編號: ${member.memberId})`;
            // 由於編號不能更改，我們將它顯示在唯讀欄位
            document.getElementById('edit-memberid').value = member.memberId; 
            document.getElementById('edit-name').value = member.name || '';
            document.getElementById('edit-idcard').value = member.idCard || '';
            document.getElementById('edit-phone').value = member.phone || '';
            document.getElementById('edit-address').value = member.address || '';

            // Show modal
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        const closeEditModal = () => {
            document.getElementById('edit-modal').classList.add('hidden');
            currentEditingMemberId = null;
        };

        // 處理儲存基本資料變更 (從 Modal 呼叫)
        const saveModalChanges = async () => {
            if (!currentEditingMemberId) return;

            const firestoreId = currentEditingMemberId;
            const newName = document.getElementById('edit-name').value.trim();
            const newIdCard = document.getElementById('edit-idcard').value.trim();
            const newPhone = document.getElementById('edit-phone').value.trim();
            const newAddress = document.getElementById('edit-address').value.trim();

            if (!newName) {
                return displayMessage('姓名不能為空。', 'error');
            }

            const memberRef = doc(db, COLLECTION_PATH, firestoreId);

            const updateData = {
                name: newName,
                idCard: newIdCard,
                phone: newPhone,
                address: newAddress,
            };

            try {
                await setDoc(memberRef, updateData, { merge: true });
                closeEditModal();
                displayMessage('會員基本資料更新成功！', 'success');
            } catch (e) {
                console.error("更新文件失敗: ", e);
                displayMessage('資料更新失敗: ' + e.message, 'error');
            }
        };

        // --- 刪除會員邏輯 ---
        const openDeleteConfirmModal = (firestoreId, memberName) => {
            currentDeletingMemberId = firestoreId;
            document.getElementById('delete-member-name').textContent = memberName;
            document.getElementById('delete-confirm-modal').classList.remove('hidden');
        };

        const closeDeleteConfirmModal = () => {
            document.getElementById('delete-confirm-modal').classList.add('hidden');
            currentDeletingMemberId = null;
        };

        const deleteMember = async () => {
            if (!currentDeletingMemberId) return;

            const firestoreId = currentDeletingMemberId;
            const memberRef = doc(db, COLLECTION_PATH, firestoreId);

            try {
                await deleteDoc(memberRef);
                closeDeleteConfirmModal();
                displayMessage('會員資料已成功刪除！', 'success');
                // The real-time listener will handle the UI update
            } catch (e) {
                console.error("刪除文件失敗: ", e);
                displayMessage('刪除失敗: ' + e.message, 'error');
            }
        };
        // --- 刪除會員邏輯結束 ---

        // 處理還款資料更新 (保留在卡片上，方便快速操作)
        const handleUpdateRepayment = async (firestoreId, memberId, year) => {
            const member = membersData.find(m => m.firestoreId === firestoreId);
            if (!member) return console.error("找不到會員進行更新");

            // 嘗試從 DOM 獲取最新值
            const amountEl = document.getElementById(`repay-amount-${firestoreId}-${year}`);
            const dateEl = document.getElementById(`repay-date-${firestoreId}-${year}`);
            const repaidEl = document.getElementById(`repaid-checkbox-${firestoreId}-${year}`);
            const lentEl = document.getElementById(`lent-checkbox-${firestoreId}-${year}`); 

            const newAmount = parseInt(amountEl.value, 10) || 0;
            const newDate = dateEl.value;
            const newRepaid = repaidEl.checked;
            const newLent = lentEl ? lentEl.checked : (member[year] ? member[year].lent : false); 

            // 更新物件
            const updateData = {
                [year]: {
                    lent: newLent,
                    repaidAmount: newAmount,
                    repaidDate: newDate,
                    repaid: newRepaid
                }
            };

            const memberRef = doc(db, COLLECTION_PATH, firestoreId);

            try {
                await setDoc(memberRef, updateData, { merge: true });
                displayMessage('還款資料更新成功！', 'success');
            } catch (e) {
                console.error("更新文件失敗: ", e);
                displayMessage('更新失敗: ' + e.message, 'error');
            }
        };

        // --- 新增頁面 (New Member View) ---
        
        const resetNewMemberForm = () => {
            document.getElementById('new-form').reset();
            // 確保 memberId 欄位是數字，並找到最大的 ID + 1
            const maxId = membersData.length > 0 ? Math.max(...membersData.map(m => m.memberId || 0)) : 0;
            const nextId = maxId + 1;
            document.getElementById('new-id').value = nextId;
        };

        const handleNewMemberSubmit = async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const memberId = parseInt(form['new-id'].value, 10);
            const name = form['new-name'].value.trim();
            const idCard = form['new-idcard'].value.trim() || '';
            const phone = form['new-phone'].value.trim() || '';
            const address = form['new-address'].value.trim() || '';

            if (!name || !memberId) {
                 return displayMessage('姓名和編號為必填項。', 'error');
            }
            
            if (membersData.some(m => m.memberId === memberId)) {
                 return displayMessage(`編號 ${memberId} 已存在，請刷新頁面獲取下一個可用編號。`, 'error');
            }
            
            const newMember = {
                memberId: memberId,
                name: name,
                idCard: idCard,
                phone: phone,
                address: address,
                '112': {
                    lent: form['new-lent-112'].checked,
                    repaidAmount: 0, repaidDate: '', repaid: false
                },
                '113': {
                    lent: form['new-lent-113'].checked,
                    repaidAmount: 0, repaidDate: '', repaid: false
                },
                '114': {
                    lent: form['new-lent-114'].checked,
                    repaidAmount: 0, repaidDate: '', repaid: false
                }
            };
            
            try {
                // 讓 Firestore 自動生成 Document ID
                const docRef = doc(collection(db, COLLECTION_PATH));
                await setDoc(docRef, newMember);
                
                displayMessage('新會員新增成功！', 'success');
                resetNewMemberForm(); // 重設表單並獲取下一個 ID
            } catch (e) {
                console.error("新增會員失敗: ", e);
                displayMessage('新增失敗: ' + e.message, 'error');
            }
        };

        // --- CSV 匯入邏輯 (略) ---
        const parseCSV = (csvText) => {
            // 基本 CSV 解析器，假設逗號分隔且結構標準
            const lines = csvText.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            // 假設第一行是標題
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                // 處理可能包含逗號在引號中的情況，這裡使用簡單的逗號分割
                const values = lines[i].split(',');
                if (values.length !== headers.length) {
                    // 這裡應是 14 欄，如果數量不符則跳過，並給出警告
                    console.warn(`Skipping line ${i + 1} (Expected ${headers.length} columns, found ${values.length}). Data: ${lines[i]}`);
                    continue;
                }

                const row = {};
                headers.forEach((header, index) => {
                    // 使用 trim() 清除頭尾空白
                    row[header.trim()] = values[index].trim();
                });
                data.push(row);
            }
            return { headers, data };
        };
        
        // 根據使用者提供的規則，將 CSV 的年度狀態欄位轉換為 Firestore 格式
        const mapYearData = (year, row) => {
            const status = (row[`${year}年`] || '').trim();
            const repaidAmount = parseInt(row[`${year}年奉還金額`], 10) || 0;
            const repaidDate = row[`${year}年奉還日期`] || '';

            let lent = false;
            let repaid = false;

            if (status === '已奉還') {
                lent = true;
                repaid = true;
            } else if (status === '未奉還') {
                lent = true;
                repaid = false;
            } else { // status is empty ('空格') or anything else
                lent = false;
                repaid = false;
            }

            return {
                lent: lent,
                repaidAmount: repaid ? repaidAmount : 0, // 僅在已奉還時記錄金額
                repaidDate: repaid ? repaidDate : '',   // 僅在已奉還時記錄日期
                repaid: repaid
            };
        };


        const handleImportCsv = async () => {
            const fileInput = document.getElementById('csv-file-input');
            if (!fileInput.files.length) {
                return displayMessage('請選擇一個 CSV 檔案。', 'error');
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                document.getElementById('import-status-text').textContent = "正在解析檔案...";
                const csvText = e.target.result;
                try {
                    const { headers, data: rawData } = parseCSV(csvText);
                    
                    if (rawData.length === 0) {
                         return displayMessage('CSV 檔案中沒有有效資料。', 'error');
                    }
                    
                    if (headers.length !== 14) {
                         return displayMessage(`標題欄位數量錯誤！應為 14 欄，但您的檔案有 ${headers.length} 欄。請檢查格式。`, 'error');
                    }

                    // 批次寫入
                    let batch = writeBatch(db);
                    let batchCount = 0;
                    let importCount = 0;
                    let existingCount = 0;
                    const existingMemberIds = new Set(membersData.map(m => m.memberId));

                    for (const row of rawData) {
                        const memberId = parseInt(row['編號'], 10);
                        const name = row['姓名'];
                        
                        document.getElementById('import-status-text').textContent = `正在處理編號 ${memberId} (${importCount + 1}/${rawData.length})`;

                        if (!memberId || !name) {
                             console.warn("Skipping row due to missing ID or Name:", row);
                             continue;
                        }

                        if (existingMemberIds.has(memberId)) {
                            // 跳過已存在的 ID，這裡可以改成更新資料的邏輯，但為了安全起見，先只新增
                            existingCount++;
                            continue;
                        }
                        
                        const newMemberData = {
                            memberId: memberId,
                            name: name || '',
                            idCard: row['身分證字號'] || '',
                            phone: row['電話'] || '', // 使用使用者提供的 '電話' 標題
                            address: row['地址'] || '',
                            '112': mapYearData('112', row),
                            '113': mapYearData('113', row),
                            '114': mapYearData('114', row),
                        };
                        
                        // 加入批次
                        const newDocRef = doc(collection(db, COLLECTION_PATH));
                        batch.set(newDocRef, newMemberData);
                        batchCount++;
                        importCount++;

                        // 每 500 次操作提交一次批次 (Firestore 限制為 500)
                        if (batchCount >= 499) { 
                            document.getElementById('import-status-text').textContent = `正在提交批次資料...`;
                            await batch.commit();
                            batch = writeBatch(db); // 重新建立新的批次
                            batchCount = 0;
                        }
                    }

                    // 提交最後的批次
                    if (batchCount > 0) {
                        await batch.commit();
                    }

                    fileInput.value = ''; // 清除檔案輸入
                    document.getElementById('import-status-text').textContent = "等待匯入新檔案...";
                    displayMessage(`CSV 匯入完成！成功新增 ${importCount} 筆資料。有 ${existingCount} 筆資料因編號已存在或無效而被跳過。`, 'success');

                } catch (error) {
                    console.error("CSV 匯入處理失敗: ", error);
                    document.getElementById('import-status-text').textContent = "匯入失敗，請檢查錯誤訊息。";
                    displayMessage('CSV 匯入失敗: ' + error.message, 'error');
                }
            };
            reader.onerror = () => {
                displayMessage('讀取檔案失敗。', 'error');
                document.getElementById('import-status-text').textContent = "匯入失敗，請檢查錯誤訊息。";
            };
            reader.readAsText(file, 'UTF-8');
        };

        // --- UI 組件產生器 ---

        /**
         * 創建會員資料卡片
         * @param {Object} member - 會員資料物件
         * @param {boolean} isEditable - 是否為還錢頁面 (可編輯)
         */
        const createMemberCard = (member, isEditable) => {
            const years = ['112', '113', '114'];
            
            let html = `
                <div class="bg-luxury-black p-4 rounded-xl shadow-2xl border border-luxury-gold/50 mb-6">
                    <div class="border-b border-luxury-gold/30 pb-2 mb-3">
                        <h3 class="text-xl font-bold text-luxury-gold flex justify-between">
                            ${member.name}
                            <span class="text-sm text-gray-400">編號: ${member.memberId}</span>
                        </h3>
            `;

            if (isEditable) {
                // 可編輯的基本資料區塊 (使用 Modal 編輯與刪除按鈕)
                html += `
                    <p class="text-sm text-gray-400">ID: ${member.idCard || '未填寫'} / Tel: ${member.phone || '未填寫'}</p>
                    <div class="flex space-x-2 mt-2">
                        <button onclick="window.openEditModal('${member.firestoreId}')" class="flex-1 p-2 rounded-lg bg-luxury-gold/20 text-luxury-gold hover:bg-luxury-gold/30 transition-colors text-xs font-medium">
                            編輯姓名/身分證/電話/地址
                        </button>
                        <button onclick="window.openDeleteConfirmModal('${member.firestoreId}', '${member.name}')" class="w-1/4 p-2 rounded-lg bg-red-600/30 text-red-400 hover:bg-red-600/50 transition-colors text-xs font-medium">
                            刪除
                        </button>
                    </div>
                `;
            } else {
                // 唯讀的基本資料區塊
                html += `
                    <p class="text-sm text-gray-400">ID: ${member.idCard || '未填寫'} / Tel: ${member.phone || '未填寫'}</p>
                    <p class="text-xs text-gray-500 truncate">地址: ${member.address || '未填寫'}</p>
                `;
            }

            html += `
                        <p class="text-xs text-red-500 mt-1">Firestore Doc ID: ${member.firestoreId}</p>
                    </div>
            `;
            
            // 每年還款記錄區塊 (保持 inline 編輯)
            years.forEach(year => {
                const data = member[year] || { lent: false, repaidAmount: 0, repaidDate: '', repaid: false };
                
                html += `
                    <div class="border-l-4 ${data.repaid ? 'border-green-500' : (data.lent ? 'border-amber-400' : 'border-gray-500')} pl-3 py-2 my-2 bg-gray-900/50 rounded-lg">
                        <h4 class="text-lg font-semibold text-white mb-2">${year} 年 發財金紀錄</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="flex items-center space-x-2">
                                <label class="text-gray-400 w-1/3">有借錢:</label>
                                ${isEditable ? 
                                    `<input type="checkbox" id="lent-checkbox-${member.firestoreId}-${year}" ${data.lent ? 'checked' : ''} class="w-4 h-4 text-luxury-gold bg-gray-700 border-gray-600 rounded focus:ring-luxury-gold" onchange="window.handleUpdateRepayment('${member.firestoreId}', ${member.memberId}, '${year}')">`
                                    : `<span class="${data.lent ? 'text-green-400' : 'text-red-400'} font-bold">${data.lent ? '是' : '否'}</span>`}
                            </div>
                            <div class="flex items-center space-x-2">
                                <label class="text-gray-400 w-1/3">已奉還:</label>
                                ${isEditable ? 
                                    `<input type="checkbox" id="repaid-checkbox-${member.firestoreId}-${year}" ${data.repaid ? 'checked' : ''} class="w-4 h-4 text-luxury-gold bg-gray-700 border-gray-600 rounded focus:ring-luxury-gold" onchange="window.handleUpdateRepayment('${member.firestoreId}', ${member.memberId}, '${year}')">`
                                    : `<span class="${data.repaid ? 'text-green-400' : 'text-red-400'} font-bold">${data.repaid ? '是' : '否'}</span>`}
                            </div>
                            
                            <div class="col-span-2">
                                <label for="repay-amount-${member.firestoreId}-${year}" class="block text-gray-400 mb-1">奉還金額:</label>
                                ${isEditable ? 
                                    `<input type="number" id="repay-amount-${member.firestoreId}-${year}" value="${data.repaidAmount}" placeholder="金額" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-luxury-gold focus:border-luxury-gold" onblur="window.handleUpdateRepayment('${member.firestoreId}', ${member.memberId}, '${year}')">`
                                    : `<p class="text-luxury-gold font-mono text-lg">${data.repaidAmount} 元</p>`}
                            </div>
                            
                            <div class="col-span-2">
                                <label for="repay-date-${member.firestoreId}-${year}" class="block text-gray-400 mb-1">奉還日期:</label>
                                ${isEditable ? 
                                    `<input type="date" id="repay-date-${member.firestoreId}-${year}" value="${data.repaidDate}" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:ring-luxury-gold focus:border-luxury-gold" onchange="window.handleUpdateRepayment('${member.firestoreId}', ${member.memberId}, '${year}')">`
                                    : `<p class="text-gray-200">${data.repaidDate || '未記錄'}</p>`}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            return html;
        };

        // 訊息顯示
        const displayMessage = (message, type = 'info') => {
            const toast = document.getElementById('toast-message');
            toast.textContent = message;
            toast.classList.remove('hidden', 'bg-green-600', 'bg-red-600', 'bg-blue-600');
            
            if (type === 'success') {
                toast.classList.remove('bg-red-600', 'bg-blue-600');
                toast.classList.add('bg-green-600');
            } else if (type === 'error') {
                toast.classList.remove('bg-green-600', 'bg-blue-600');
                toast.classList.add('bg-red-600');
            } else {
                toast.classList.remove('bg-green-600', 'bg-red-600');
                toast.classList.add('bg-blue-600');
            }
             
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        };

        // --- 暴露給全域環境，以供 HTML onclick 呼叫 (確保點擊反應) ---
        window.showView = showView;
        window.handleRepaySearch = handleRepaySearch;
        window.handleQuerySearch = handleQuerySearch;
        window.handleUpdateRepayment = handleUpdateRepayment;
        window.handleNewMemberSubmit = handleNewMemberSubmit;
        window.handleImportCsv = handleImportCsv; 
        window.openEditModal = openEditModal; 
        window.closeEditModal = closeEditModal; 
        window.saveModalChanges = saveModalChanges; 
        window.openDeleteConfirmModal = openDeleteConfirmModal; // 暴露刪除確認函數
        window.closeDeleteConfirmModal = closeDeleteConfirmModal; // 暴露關閉刪除確認函數
        window.deleteMember = deleteMember; // 暴露執行刪除函數

        
        // 初始化應用
        initFirebase();
    </script>

    <style>
        /* 針對黑金奢華風的客製化樣式 */
        .gold-button {
            background: linear-gradient(145deg, #FFD700, #B8860B);
            color: #1a1a1a;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }
        .gold-button:hover {
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
            transform: translateY(-2px);
        }
        .gold-input:focus {
             border-color: #FFD700 !important;
             box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.5);
        }
        /* 將日期和數字輸入框的文字顏色設為白色，確保在深色背景下可見 */
        input[type="date"], input[type="number"], input[type="text"], input[type="tel"] {
            color: white;
        }

        /* 隱藏 Chrome/Safari 的數字輸入框箭頭 */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }
        /* 隱藏 Firefox 的數字輸入框箭頭 */
        input[type=number] {
          -moz-appearance: textfield;
        }

        /* 檔案選擇按鈕樣式 */
        .file-input-style::file-selector-button {
            background: linear-gradient(145deg, #FFD700, #B8860B);
            color: #1a1a1a;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: none;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .file-input-style::file-selector-button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body class="bg-luxury-bg font-sans min-h-screen text-white antialiased p-4 sm:p-6">

    <!-- 頂部浮動訊息提示 -->
    <div id="toast-message" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 p-3 rounded-xl shadow-lg z-50 transition-all duration-300 text-center text-sm font-semibold">
        訊息內容
    </div>
    
    <!-- 讀取中/錯誤覆蓋層 -->
    <div id="loading-overlay" class="fixed inset-0 bg-luxury-bg flex flex-col items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-luxury-gold"></div>
        <p class="mt-4 text-luxury-gold text-lg">系統初始化中，請稍候...</p>
        <p id="error-message" class="text-red-500 mt-2 text-sm"></p>
    </div>

    <!-- 應用主容器 -->
    <div id="app-container" class="hidden max-w-lg mx-auto bg-luxury-black rounded-3xl shadow-2xl p-4 sm:p-6">
        
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-luxury-gold border-b-2 border-luxury-gold/50 pb-2">金山承天宮</h1>
            <p class="text-xl mt-1 text-gray-300">發財金管理系統</p>
            <p id="user-id-display" class="text-xs text-gray-500 mt-1"></p>
        </header>

        <!-- 2. 儀表板/導航頁面 (Dashboard View) -->
        <div id="dashboard-view" class="app-view">
            <h2 class="text-2xl font-semibold text-white mb-6 text-center">功能選單</h2>
            <div class="grid grid-cols-1 gap-5">
                <button onclick="showView('repay')" class="gold-button w-full p-4 rounded-xl text-lg flex items-center justify-center space-x-2">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM8 11V9h4v2H8z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                    <span>發財金與資料更新</span>
                </button>
                <button onclick="showView('query')" class="gold-button w-full p-4 rounded-xl text-lg flex items-center justify-center space-x-2">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.31l3.593 3.592a1 1 0 01-1.414 1.414l-3.592-3.593A7 7 0 012 9z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                    <span>會員資料查詢</span>
                </button>
                <button onclick="showView('new')" class="gold-button w-full p-4 rounded-xl text-lg flex items-center justify-center space-x-2">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                    <span>新增與匯入會員資料</span>
                </button>
            </div>
        </div>

        <!-- 3. 還錢/更新頁面 (Repayment/Update View) -->
        <div id="repay-view" class="app-view hidden">
            <h2 class="text-2xl font-semibold text-luxury-gold mb-6 text-center">發財金與基本資料更新</h2>
            
            <div class="space-y-4 mb-6">
                <input type="text" id="search-input-repay" placeholder="輸入編號/姓名/身分證/電話進行查詢" class="gold-input w-full p-3 bg-gray-800 border-2 border-gray-700 rounded-xl text-white focus:outline-none focus:border-luxury-gold">
                <button onclick="handleRepaySearch()" class="gold-button w-full p-3 rounded-xl text-base">
                    查 詢
                </button>
            </div>
            
            <div id="repay-results" class="space-y-4">
                <!-- 查詢結果會在這裡顯示，包含可編輯的還款欄位和編輯按鈕 -->
                <p class="text-gray-500 text-center">輸入查詢條件後，結果將顯示於此。</p>
            </div>

            <button onclick="showView('dashboard')" class="mt-8 w-full p-3 rounded-xl bg-gray-700 text-white hover:bg-gray-600 transition-colors">
                返回選單
            </button>
        </div>

        <!-- 4. 查詢頁面 (Query View) -->
        <div id="query-view" class="app-view hidden">
            <h2 class="text-2xl font-semibold text-luxury-gold mb-6 text-center">會員資料查詢</h2>
            
            <div class="space-y-4 mb-6">
                <input type="text" id="search-input-query" placeholder="輸入編號/姓名/身分證/電話進行查詢" class="gold-input w-full p-3 bg-gray-800 border-2 border-gray-700 rounded-xl text-white focus:outline-none focus:border-luxury-gold">
                <button onclick="handleQuerySearch()" class="gold-button w-full p-3 rounded-xl text-base">
                    查 詢
                </button>
            </div>
            
            <div id="query-results" class="space-y-4">
                <!-- 查詢結果會在這裡以唯讀卡片顯示 -->
                <p class="text-gray-500 text-center">輸入查詢條件後，結果將顯示於此。</p>
            </div>

            <button onclick="showView('dashboard')" class="mt-8 w-full p-3 rounded-xl bg-gray-700 text-white hover:bg-gray-600 transition-colors">
                返回選單
            </button>
        </div>

        <!-- 5. 新增頁面 (New Member View) -->
        <div id="new-view" class="app-view hidden">
            <h2 class="text-2xl font-semibold text-luxury-gold mb-6 text-center">新增與匯入會員資料</h2>
            
            <!-- 匯入 CSV 區塊 -->
            <div class="bg-gray-900 p-4 rounded-xl border border-luxury-gold/50 mb-6 space-y-3">
                <h3 class="text-xl text-luxury-gold font-bold">CSV 批次匯入</h3>
                <p class="text-sm text-gray-400 leading-relaxed">請確保您的 CSV 檔案包含以下 **14 個欄位**，並以逗號分隔：
                    <code class="text-luxury-gold text-xs block mt-1 p-2 bg-gray-800 rounded-lg overflow-x-auto">編號, 姓名, 身分證字號, 電話, 地址, 112年奉還金額, 112年奉還日期, 112年, 113年奉還金額, 113年奉還日期, 113年, 114年奉還金額, 114年奉還日期, 114年</code>
                </p>
                <p class="text-xs text-red-400">注意: 每年狀態欄位 (112年, 113年, 114年) 內容請填寫 **已奉還**、**未奉還** 或 **留空**。</p>

                <input type="file" id="csv-file-input" accept=".csv" class="file-input-style w-full text-sm text-gray-300">
                <button onclick="handleImportCsv()" class="gold-button w-full p-3 rounded-xl text-base mt-2">
                    開始匯入 CSV 資料
                </button>
                <p id="import-status-text" class="text-xs text-gray-500 pt-1 text-center">等待匯入新檔案...</p>
            </div>

            <!-- 手動新增表單 -->
            <h3 class="text-xl font-bold text-gray-300 border-t border-gray-700 pt-6 mb-4">手動新增單筆資料</h3>
            
            <form id="new-form" onsubmit="handleNewMemberSubmit(event)" class="space-y-4">
                
                <div class="grid grid-cols-2 gap-4">
                     <!-- 編號 (ID) - 需自動生成 -->
                    <div>
                        <label for="new-id" class="block text-sm font-medium text-gray-400">編號 (自動生成)</label>
                        <input type="number" id="new-id" name="new-id" required readonly class="gold-input w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-luxury-gold font-bold cursor-not-allowed">
                    </div>
                     <!-- 姓名 -->
                    <div>
                        <label for="new-name" class="block text-sm font-medium text-gray-400">姓名 *</label>
                        <input type="text" id="new-name" name="new-name" required placeholder="王小華" class="gold-input w-full p-3 bg-gray-800 border-2 border-gray-700 rounded-lg text-white">
                    </div>
                </div>

                <!-- 身分證 -->
                <div>
                    <label for="new-idcard" class="block text-sm font-medium text-gray-400">身分證字號</label>
                    <input type="text" id="new-idcard" name="new-idcard" placeholder="A123456789" class="gold-input w-full p-3 bg-gray-800 border-2 border-gray-700 rounded-lg text-white">
                </div>

                <!-- 電話 -->
                <div>
                    <label for="new-phone" class="block text-sm font-medium text-gray-400">電話號碼</label>
                    <input type="tel" id="new-phone" name="new-phone" placeholder="09XX-XXX-XXX" class="gold-input w-full p-3 bg-gray-800 border-2 border-gray-700 rounded-lg text-white">
                </div>

                <!-- 地址 -->
                <div>
                    <label for="new-address" class="block text-sm font-medium text-gray-400">地址</label>
                    <input type="text" id="new-address" name="new-address" placeholder="台北市金山區承天路1號" class="gold-input w-full p-3 bg-gray-800 border-2 border-gray-700 rounded-lg text-white">
                </div>
                
                <p class="text-luxury-gold text-base pt-2 border-t border-gray-700/50">每年是否有借發財金 (請勾選)</p>

                <!-- 每年是否有借錢的勾選 -->
                <div class="grid grid-cols-3 gap-4 bg-gray-900 p-3 rounded-xl border border-gray-800">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="new-lent-112" name="new-lent-112" class="w-4 h-4 text-luxury-gold bg-gray-700 border-gray-600 rounded focus:ring-luxury-gold">
                        <label for="new-lent-112" class="text-gray-300">112年</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="new-lent-113" name="new-lent-113" class="w-4 h-4 text-luxury-gold bg-gray-700 border-gray-600 rounded focus:ring-luxury-gold">
                        <label for="new-lent-113" class="text-gray-300">113年</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="new-lent-114" name="new-lent-114" class="w-4 h-4 text-luxury-gold bg-gray-700 border-gray-600 rounded focus:ring-luxury-gold">
                        <label for="new-lent-114" class="text-gray-300">114年</label>
                    </div>
                </div>

                <button type="submit" class="gold-button w-full p-3 rounded-xl text-lg mt-4">
                    手動新增單筆資料
                </button>
            </form>

            <button onclick="showView('dashboard')" class="mt-8 w-full p-3 rounded-xl bg-gray-700 text-white hover:bg-gray-600 transition-colors">
                返回選單
            </button>
        </div>
        
    </div>

    <!-- 6. 編輯資料彈出視窗 (Modal) -->
    <div id="edit-modal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-75 flex items-center justify-center p-4" onclick="closeEditModal()">
        <div class="bg-luxury-black rounded-2xl shadow-3xl w-full max-w-md border border-luxury-gold/50" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 id="edit-modal-title" class="text-2xl font-bold text-luxury-gold mb-4 border-b border-luxury-gold/30 pb-2">編輯會員資料</h3>
                
                <div class="space-y-4">
                    <!-- 編號 (唯讀) -->
                    <div>
                        <label for="edit-memberid" class="block text-sm font-medium text-gray-400">會員編號 (不可更改)</label>
                        <input type="number" id="edit-memberid" readonly class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg text-luxury-gold font-bold cursor-not-allowed">
                    </div>

                    <!-- 姓名 (可更改) -->
                    <div>
                        <label for="edit-name" class="block text-sm font-medium text-gray-400">姓名 *</label>
                        <input type="text" id="edit-name" required placeholder="姓名" class="gold-input w-full p-3 bg-gray-800 border-2 border-gray-700 rounded-lg text-white">
                    </div>

                    <!-- 身分證字號 -->
                    <div>
                        <label for="edit-idcard" class="block text-sm font-medium text-gray-400">身分證字號</label>
                        <input type="text" id="edit-idcard" placeholder="身分證字號" class="gold-input w-full p-3 bg-gray-800 border-2 border-gray-700 rounded-lg text-white">
                    </div>

                    <!-- 電話號碼 -->
                    <div>
                        <label for="edit-phone" class="block text-sm font-medium text-gray-400">電話號碼</label>
                        <input type="tel" id="edit-phone" placeholder="電話號碼" class="gold-input w-full p-3 bg-gray-800 border-2 border-gray-700 rounded-lg text-white">
                    </div>

                    <!-- 地址 -->
                    <div>
                        <label for="edit-address" class="block text-sm font-medium text-gray-400">地址</label>
                        <input type="text" id="edit-address" placeholder="地址" class="gold-input w-full p-3 bg-gray-800 border-2 border-gray-700 rounded-lg text-white">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="window.closeEditModal()" class="px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition-colors">
                        取 消
                    </button>
                    <button onclick="window.saveModalChanges()" class="gold-button px-4 py-2 rounded-lg">
                        儲存變更
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 7. 刪除確認彈出視窗 (Delete Confirmation Modal) -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-75 flex items-center justify-center p-4" onclick="closeDeleteConfirmModal()">
        <div class="bg-luxury-black rounded-2xl shadow-3xl w-full max-w-sm border border-red-600/50" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 class="text-2xl font-bold text-red-500 mb-3">確認刪除</h3>
                
                <p class="text-gray-300">您確定要永久刪除會員 <span id="delete-member-name" class="font-bold text-luxury-gold"></span> 的資料嗎？</p>
                <p class="text-sm text-red-400 mt-2">此操作不可復原，請謹慎操作！</p>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="window.closeDeleteConfirmModal()" class="px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition-colors">
                        取 消
                    </button>
                    <button onclick="window.deleteMember()" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors font-semibold">
                        確認刪除
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

